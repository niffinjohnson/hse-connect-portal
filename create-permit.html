<!DOCTYPE html>
<html>
<head>
  <title>Create Work Permit - HSE Connect</title>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body {
      font-family: Arial;
      background: #f4f6f9;
      padding: 40px;
    }

    .container {
      max-width: 800px;
      margin: auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    h2 {
      text-align: center;
      margin-bottom: 25px;
    }

    input, select, textarea {
      width: 100%;
      padding: 8px;
      margin: 8px 0 15px;
    }

    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 5px;
    }

    .checklist-item {
      margin-bottom: 8px;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>

<div class="container">
  <h2>Create Work Permit</h2>

  <label>Permit Type</label>
  <select id="permitType" onchange="loadChecklist()">
    <option value="">Select Permit Type</option>
    <option value="Hot Work">Hot Work</option>
    <option value="Confined Space">Confined Space</option>
    <option value="Work at Height">Work at Height</option>
    <option value="Rigging">Rigging / Erection / Lifting</option>
  </select>

  <label>Project / Location</label>
  <input type="text" id="location">

  <label>Contractor Name</label>
  <input type="text" id="contractor">

  <label>Work Description</label>
  <textarea id="description"></textarea>

  <label>Start Date</label>
  <input type="date" id="startDate">

  <label>End Date</label>
  <input type="date" id="endDate">

  <h3>Checklist</h3>
  <div id="checklistArea"></div>

  <br>
  <button onclick="submitPermit()">Submit Permit</button>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDsFX7tQezhtJi6GkVBpZXn7YyJgZfyi7o",
    authDomain: "hse-connect-5b0a3.firebaseapp.com",
    projectId: "hse-connect-5b0a3",
    storageBucket: "hse-connect-5b0a3.firebasestorage.app",
    messagingSenderId: "1017230242361",
    appId: "1:1017230242361:web:66d427e171595aae5c53e8",
    measurementId: "G-2GGKDEJTKW"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  let currentUserRole = "";

  auth.onAuthStateChanged(async (user) => {
    if (!user) {
      window.location.href = "index.html";
    } else {
      const doc = await db.collection("users").doc(user.email).get();
      if (doc.exists) {
        currentUserRole = doc.data().role;

        if (currentUserRole === "Contractor") {
          alert("Contractors cannot create permits.");
          window.location.href = "dashboard.html";
        }
      } else {
        alert("No role assigned.");
        window.location.href = "dashboard.html";
      }
    }
  });

  function loadChecklist() {
    const type = document.getElementById("permitType").value;
    const checklistArea = document.getElementById("checklistArea");
    checklistArea.innerHTML = "";

    let items = [];

    if (type === "Hot Work") {
      items = [
        "Fire extinguisher available",
        "Fire pump operational",
        "Gas cylinders secured",
        "Flashback arrestor installed",
        "Area cleared of combustible material"
      ];
    }

    if (type === "Confined Space") {
      items = [
        "Gas test conducted",
        "Oxygen level checked",
        "Rescue team available",
        "SCBA provided",
        "Standby person assigned"
      ];
    }

    if (type === "Work at Height") {
      items = [
        "Life line in place",
        "Safety harness provided",
        "Access ladder secured",
        "Area cordoned",
        "Fall arrestor provided"
      ];
    }

    if (type === "Rigging") {
      items = [
        "Lifting plan approved",
        "Certified lifting equipment used",
        "Signal man available",
        "Area barricaded",
        "Test certificates verified"
      ];
    }

    items.forEach(item => {
      checklistArea.innerHTML += `
        <div class="checklist-item">
          <input type="checkbox" value="${item}"> ${item}
        </div>
      `;
    });
  }

  async function submitPermit() {
    const user = auth.currentUser;
    const type = document.getElementById("permitType").value;

    if (!type) {
      alert("Select Permit Type");
      return;
    }

    const checklistChecked = [];
    document.querySelectorAll("#checklistArea input:checked")
      .forEach(cb => checklistChecked.push(cb.value));

    await db.collection("permits").add({
      permitType: type,
      location: document.getElementById("location").value,
      contractor: document.getElementById("contractor").value,
      description: document.getElementById("description").value,
      startDate: document.getElementById("startDate").value,
      endDate: document.getElementById("endDate").value,
      checklist: checklistChecked,
      status: "Pending",
      createdBy: user.email,
      createdAt: new Date()
    });

    alert("Permit Submitted Successfully!");
    window.location.href = "dashboard.html";
  }
</script>

</body>
</html>
